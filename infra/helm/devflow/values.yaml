# DevFlow Helm Chart - Default Values
# Phase 6: Kubernetes Deployment

# ============================================
# Global Configuration
# ============================================
global:
  environment: development
  domain: devflow.local
  
  # Image registry
  imageRegistry: docker.io
  imagePullSecrets: []
  
  # Multi-tenant
  multiTenant:
    enabled: true
    defaultOrganization: "default-org"
  
  # Database (managed Postgres)
  database:
    host: postgres.database.svc.cluster.local
    port: 5432
    database: devflow
    # Credentials in secret
    existingSecret: devflow-database
    secretKeys:
      username: POSTGRES_USER
      password: POSTGRES_PASSWORD
  
  # Redis (managed)
  redis:
    host: redis.cache.svc.cluster.local
    port: 6379
    existingSecret: devflow-redis
    secretKeys:
      password: REDIS_PASSWORD
  
  # Temporal
  temporal:
    # Option A: Self-hosted in cluster
    # host: temporal-frontend.temporal.svc.cluster.local
    # Option B: Temporal Cloud
    host: "namespace.tmprl.cloud"
    port: 7233
    namespace: devflow
    existingSecret: devflow-temporal
    secretKeys:
      tls_cert: TEMPORAL_TLS_CERT
      tls_key: TEMPORAL_TLS_KEY

# ============================================
# DevFlow API
# ============================================
api:
  enabled: true
  
  replicaCount: 2
  
  image:
    repository: devflow/api
    pullPolicy: IfNotPresent
    tag: "1.6.0"
  
  service:
    type: ClusterIP
    port: 3000
    annotations: {}
  
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/rate-limit: "100"
    hosts:
      - host: api.devflow.local
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: devflow-api-tls
        hosts:
          - api.devflow.local
  
  # Environment variables
  env:
    NODE_ENV: production
    LOG_LEVEL: info
    PORT: "3000"
    
    # Feature flags
    ENABLE_SWAGGER: "false"
    ENABLE_METRICS: "true"
    ENABLE_TRACING: "true"
  
  # Secrets (from Kubernetes Secret)
  secrets:
    # API Keys
    - name: ANTHROPIC_API_KEY
      secretName: devflow-secrets
      secretKey: anthropic-api-key
    - name: OPENAI_API_KEY
      secretName: devflow-secrets
      secretKey: openai-api-key
    - name: GITHUB_TOKEN
      secretName: devflow-secrets
      secretKey: github-token
    - name: NOTION_API_KEY
      secretName: devflow-secrets
      secretKey: notion-api-key
    
    # JWT Secret
    - name: JWT_SECRET
      secretName: devflow-secrets
      secretKey: jwt-secret
  
  # Health checks
  livenessProbe:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  # Resources
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  
  # Autoscaling
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 50
    targetMemoryUtilizationPercentage: 70
  
  # Pod annotations
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "3000"
    prometheus.io/path: "/metrics"
  
  # Security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
  
  # Node selector
  nodeSelector: {}
  
  # Tolerations
  tolerations: []
  
  # Affinity
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - devflow-api
            topologyKey: kubernetes.io/hostname

# ============================================
# DevFlow Worker (Temporal)
# ============================================
worker:
  enabled: true
  
  replicaCount: 3
  
  image:
    repository: devflow/worker
    pullPolicy: IfNotPresent
    tag: "1.6.0"
  
  # No service needed (workers connect to Temporal)
  service:
    enabled: false
  
  # Environment variables
  env:
    NODE_ENV: production
    LOG_LEVEL: info
    
    # Temporal Worker config
    TEMPORAL_TASK_QUEUE: devflow-tasks
    TEMPORAL_MAX_CONCURRENT_ACTIVITIES: "10"
    TEMPORAL_MAX_CONCURRENT_WORKFLOWS: "5"
    
    # Metrics server for probes
    METRICS_PORT: "9464"
  
  # Same secrets as API
  secrets:
    - name: ANTHROPIC_API_KEY
      secretName: devflow-secrets
      secretKey: anthropic-api-key
    - name: OPENAI_API_KEY
      secretName: devflow-secrets
      secretKey: openai-api-key
    - name: GITHUB_TOKEN
      secretName: devflow-secrets
      secretKey: github-token
    - name: NOTION_API_KEY
      secretName: devflow-secrets
      secretKey: notion-api-key
  
  # Health checks (metrics endpoint)
  livenessProbe:
    httpGet:
      path: /metrics
      port: 9464
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /metrics
      port: 9464
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  # Resources
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi
  
  # Autoscaling
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 60
    targetMemoryUtilizationPercentage: 75
  
  # Pod annotations
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9464"
    prometheus.io/path: "/metrics"
  
  # Security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
  
  nodeSelector: {}
  tolerations: []
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - devflow-worker
            topologyKey: kubernetes.io/hostname

# ============================================
# Temporal Server (Self-hosted - Optional)
# ============================================
temporal:
  enabled: false  # Set to true for self-hosted, false for Temporal Cloud
  
  # Temporal chart values (if enabled)
  server:
    replicaCount: 1
    
    config:
      persistence:
        default:
          driver: "sql"
          sql:
            driver: "postgres"
            host: postgres.database.svc.cluster.local
            port: 5432
            database: temporal
            maxConns: 20
            maxIdleConns: 20
        
        visibility:
          driver: "sql"
          sql:
            driver: "postgres"
            host: postgres.database.svc.cluster.local
            port: 5432
            database: temporal_visibility
            maxConns: 10
            maxIdleConns: 10
  
  web:
    enabled: true
    replicaCount: 1
    
    ingress:
      enabled: true
      hosts:
        - temporal-ui.devflow.local

# ============================================
# Observability (Optional)
# ============================================
observability:
  # Prometheus
  prometheus:
    enabled: false  # Set to true to deploy Prometheus
    
    server:
      persistentVolume:
        enabled: true
        size: 50Gi
      
      retention: "30d"
      
      ingress:
        enabled: true
        hosts:
          - prometheus.devflow.local
  
  # Grafana
  grafana:
    enabled: false  # Set to true to deploy Grafana
    
    adminPassword: "changeme"
    
    persistence:
      enabled: true
      size: 10Gi
    
    ingress:
      enabled: true
      hosts:
        - grafana.devflow.local
  
  # OTEL Collector
  otelCollector:
    enabled: false  # Set to true to deploy OTEL Collector
    
    mode: deployment
    
    config:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318
      
      processors:
        batch: {}
        memory_limiter:
          limit_mib: 512
      
      exporters:
        prometheus:
          endpoint: "0.0.0.0:8889"
        
        otlp/tempo:
          endpoint: "tempo:4317"
          tls:
            insecure: true

# ============================================
# Service Account
# ============================================
serviceAccount:
  create: true
  annotations: {}
  name: "devflow"

# ============================================
# RBAC
# ============================================
rbac:
  create: true

# ============================================
# Pod Disruption Budget
# ============================================
podDisruptionBudget:
  api:
    enabled: true
    minAvailable: 1
  
  worker:
    enabled: true
    minAvailable: 2

# ============================================
# Network Policy
# ============================================
networkPolicy:
  enabled: false
  policyTypes:
    - Ingress
    - Egress

# ============================================
# Secrets Management
# ============================================
secrets:
  # Use external secrets operator
  externalSecrets:
    enabled: false
    backend: "doppler"  # or "vault", "aws-secrets-manager"
    
    # Doppler config
    doppler:
      project: devflow
      config: prd
  
  # Use sealed secrets
  sealedSecrets:
    enabled: false
  
  # Manual secrets (not recommended for prod)
  createSecrets: true

